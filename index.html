<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Perdona a tu Princesa - Pixel Avanzado</title>
<style>
body{
  margin:0;
  overflow:hidden;
  background:#8bb7ff;
  font-family:monospace;
}

#camera{
  position:relative;
  width:100vw;
  height:100vh;
  overflow:hidden;
}

#world{
  position:absolute;
  height:100%;
  width:7000px;
}

/* PISO PIXELADO */
.ground{
  position:absolute;
  bottom:0;
  width:7000px;
  height:100px;
  background:
    repeating-linear-gradient(
      90deg,
      #c06030 0px,
      #c06030 16px,
      black 16px,
      black 18px
    ),
    repeating-linear-gradient(
      0deg,
      #c06030 0px,
      #c06030 16px,
      black 16px,
      black 18px
    );
}

/* PERSONAJE PIXEL */
.player{
  position:absolute;
  width:24px;
  height:24px;
  background:#ffcc99;
  border:2px solid black;
  bottom:100px;
  left:150px;
}

/* ENEMIGOS PIXEL */
.enemy{
  position:absolute;
  width:16px;
  height:16px;
  background:#8b0000;
  border:2px solid black;
  bottom:100px;
}

.dragon{
  position:absolute;
  width:32px;
  height:32px;
  background:#550000;
  border:3px solid black;
  bottom:100px;
}

/* META PIXEL */
.goal{
  position:absolute;
  width:8px;
  height:48px;
  background:yellow;
  border:2px solid black;
  bottom:100px;
}

/* NUBES PIXEL */
.cloud{
  position:absolute;
  width:16px;
  height:8px;
  background:white;
  border:1px solid #ccc;
}

/* OVERLAY */
#overlay{
  position:fixed;
  width:100%;
  height:100%;
  background:black;
  color:white;
  display:none;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  font-size:20px;
  text-align:center;
  z-index:999;
}

/* FUEGOS PIXEL */
.firework{
  position:absolute;
  width:4px;
  height:4px;
  border-radius:50%;
}
</style>
</head>
<body>

<div id="overlay"></div>

<div id="camera">
  <div id="world">
    <div class="ground"></div>
    <div class="player" id="player"></div>

    <div class="enemy" style="left:300px;"></div>
    <div class="enemy" style="left:600px;"></div>
    <div class="enemy" style="left:900px;"></div>

    <div class="dragon" style="left:1200px;"></div>
    <div class="goal" style="left:2000px;"></div>

    <!-- NUBES PIXEL -->
    <div class="cloud" style="left:400px; top:50px;"></div>
    <div class="cloud" style="left:600px; top:30px;"></div>
    <div class="cloud" style="left:900px; top:60px;"></div>
  </div>
</div>

<script>
const player = document.getElementById("player");
const world = document.getElementById("world");
const overlay = document.getElementById("overlay");
let enemies = Array.from(document.querySelectorAll(".enemy"));
const dragon = document.querySelector(".dragon");
const goal = document.querySelector(".goal");
let clouds = Array.from(document.querySelectorAll(".cloud"));

let position = 150;
let velocityY = 0;
let gravity = 1;
let jumpsQueue = 0;
let lives = 3;
let level = 1;
let perfectLevel = true;

// Guardar posiciones iniciales
const enemyPositions = enemies.map(e => parseInt(e.style.left));
const dragonInitialX = parseInt(dragon.style.left);
let dragonDirection = 1;

document.addEventListener("keydown", e=>{
  if(e.key==="ArrowRight") position += 3; // jugador m치s r치pido
  if(e.key==="ArrowLeft") position -= 3;
  if(position < 0) position = 0;
  if(e.key===" "){
    jumpsQueue += 1;
  }
});

function gameLoop(){
  // SALTO M칔LTIPLE
  if(jumpsQueue > 0 && velocityY === 0){
    velocityY = -12;
    jumpsQueue--;
  }

  velocityY += gravity;
  let bottom = parseInt(player.style.bottom||100);
  bottom -= velocityY;
  if(bottom <= 100){
    bottom = 100;
    velocityY = 0;
  }
  player.style.bottom = bottom+"px";
  player.style.left = position+"px";

  // C츼MARA
  let cameraX = position - 150;
  if(cameraX < 0) cameraX = 0;
  world.style.transform = `translateX(${-cameraX}px)`;

  moveEnemies();
  moveDragon();
  moveClouds();
  checkCollision();

  requestAnimationFrame(gameLoop);
}

function moveEnemies(){
  enemies.forEach(enemy=>{
    let enemyX = parseInt(enemy.style.left);
    // m치s lentos que el jugador
    if(enemyX > position){
      enemy.style.left = (enemyX - 1)+"px";
    } else {
      enemy.style.left = (enemyX + 1)+"px";
    }
  });
}

function moveDragon(){
  let dragonX = parseInt(dragon.style.left);
  dragonX += dragonDirection * 1;
  if(dragonX > dragonInitialX + 64 || dragonX < dragonInitialX - 64){
    dragonDirection *= -1;
  }
  dragon.style.left = dragonX + "px";
}

function moveClouds(){
  clouds.forEach(cloud=>{
    let left = parseInt(cloud.style.left);
    left -= 0.5; 
    if(left < -16) left = 7000;
    cloud.style.left = left+"px";
  });
}

function checkCollision(){
  enemies.forEach((enemy, i)=>{
    if(isColliding(player, enemy)){
      // si cae sobre el enemigo
      if(parseInt(player.style.bottom)+parseInt(player.style.height) - velocityY <= parseInt(enemy.style.bottom) + 4){
        // enemigo muere
        enemy.remove();
        enemies.splice(i,1);
      } else {
        loseLife();
      }
    }
  });
  if(isColliding(player, dragon)) loseLife();
  if(isColliding(player, goal)) winLevel();
}

function isColliding(a,b){
  const r1 = a.getBoundingClientRect();
  const r2 = b.getBoundingClientRect();
  return !(r1.top > r2.bottom || r1.bottom < r2.top || r1.right < r2.left || r1.left > r2.right);
}

function loseLife(){
  if(lives <= 0) return;
  lives--;
  perfectLevel = false;
  overlay.innerHTML =
    `JAJAJA TE TOCA OTRA VEZ POR BOBIS<br><br>NIVEL ${level}<br>VIDAS: ${lives}<br>PREP츼RATE PARA JUGAR`;
  overlay.style.display="flex";
  
  setTimeout(resetLevel, 3000); // 3 segundos antes de reiniciar

  if(lives === 0){
    setTimeout(()=>overlay.innerHTML="GAME OVER PAPITO,<br>YA PERD칍NAME",2000);
  }
}

function resetLevel(){
  position = 150;
  player.style.left="150px";
  // reset enemigos
  enemies.forEach((e,i)=> e.style.left = enemyPositions[i]+"px");
  dragon.style.left = dragonInitialX+"px";

  overlay.style.display="none";
}

function winLevel(){
  overlay.style.display="flex";
  if(perfectLevel) fireworks();
  overlay.innerHTML = perfectLevel ?
    `춰Nivel Perfecto! 游땙<br>Prep치rate para el siguiente` :
    `Nivel completado 游땚<br>Pero podr칤as mejorar`;

  level++;
  lives=3;
  perfectLevel=true;

  // a침adir m치s nubes por nivel
  for(let i=0;i<level;i++){
    let c = document.createElement("div");
    c.className="cloud";
    c.style.left = (Math.random()*7000)+"px";
    c.style.top = (Math.random()*80 + 20)+"px";
    world.appendChild(c);
    clouds.push(c);
  }

  setTimeout(()=>overlay.style.display="none",2000);
}

function fireworks(){
  const colors = ["yellow","red","orange","white","blue"];
  for(let i=0;i<50;i++){
    let f = document.createElement("div");
    f.className="firework";
    f.style.background = colors[Math.floor(Math.random()*colors.length)];
    f.style.left = Math.floor(Math.random()*window.innerWidth)+"px";
    f.style.top = Math.floor(Math.random()*100)+"px";
    document.body.appendChild(f);

    let top = parseFloat(f.style.top);
    let left = parseFloat(f.style.left);
    let angle = Math.random()*2*Math.PI;
    let speed = 1 + Math.random()*2;

    let interval = setInterval(()=>{
      top -= Math.cos(angle)*speed;
      left += Math.sin(angle)*speed;
      f.style.top = Math.floor(top)+"px";
      f.style.left = Math.floor(left)+"px";
    },16);

    setTimeout(()=>{
      clearInterval(interval);
      f.remove();
    },1000);
  }
}

gameLoop();
</script>
</body>
</html>
